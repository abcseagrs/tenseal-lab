# 동형암호 1:1 통신 실습 매뉴얼

> **실습 형태**: 2인 1조
> **소요 시간**: 약 60~90분

---

## 목차

1. [실습 개요](#1-실습-개요)
2. [환경 구축](#2-환경-구축)
3. [프로그램 실행 방법](#3-프로그램-실행-방법)
4. [트러블슈팅](#4-트러블슈팅)
5. [실습 확인 사항](#5-실습-확인-사항)

---

## 1. 실습 개요

### 1.1 학습 목표

이 실습을 통해 다음을 이해합니다:

- **동형암호(Homomorphic Encryption)**: 암호화된 상태에서 연산이 가능한 암호 기술
- **비밀키 격리**: PC B는 비밀키 없이도 암호화된 데이터를 전송할 수 있음
- **프라이버시 보존 연산**: 평문을 노출하지 않고 덧셈 연산 수행

### 1.2 실습 시나리오

```
PC A (서버)                           PC B (클라이언트)
    |                                      |
    | 1. 비밀키 생성                        |
    | 2. 자신의 데이터 암호화 [10, 20]      |
    | 3. 포트 5000에서 대기                 |
    |                                      |
    | <-------- 4. 연결 요청 ------------- |
    |                                      |
    | ----- 5. 공개 키 전송 ------------> |
    |                                      | 6. 자신의 데이터 암호화 [30, 40]
    |                                      |
    | <--- 7. 암호화 데이터 전송 --------- |
    |                                      |
    | 8. 암호화 상태로 덧셈 수행            |
    | 9. 결과 복호화 → [40, 60]            |
    |                                      |
```

### 1.3 예상 결과

- PC A의 데이터: `[10, 20]`
- PC B의 데이터: `[30, 40]`
- **최종 결과**: `[40, 60]` (10+30=40, 20+40=60)

---

## 2. 환경 구축

### 2.1 도커 프로그램 설치 (Windows 환경)

#### 2.1.1 시스템 요구사항

- Windows 10/11 (64비트)
- 최소 4GB RAM (8GB 권장)
- 약 5GB 여유 디스크 공간
- 인터넷 연결

#### 2.1.2 Docker Desktop 설치

**Step 1: 다운로드**

1. [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/) 공식 사이트 접속
2. "Download for Windows" 버튼 클릭
3. `Docker Desktop Installer.exe` 다운로드

**Step 2: 설치**

1. 다운로드한 설치 파일 실행
2. "Use WSL 2 instead of Hyper-V" 옵션 **체크** (권장)
3. "Install" 버튼 클릭
4. 설치 완료 후 컴퓨터 재시작

**Step 3: 설치 확인**

1. Docker Desktop 실행
2. 오른쪽 하단 트레이 아이콘에서 Docker 로고 확인
3. 명령 프롬프트(cmd) 또는 PowerShell 열기
4. 다음 명령어 실행:

```bash
docker --version
```

출력 예시:
```
Docker version 24.0.7, build afdd53b
```

#### 2.1.3 WSL 2 설치 (필요시)

Docker Desktop이 WSL 2를 요구하는 경우:

1. PowerShell을 **관리자 권한**으로 실행
2. 다음 명령어 실행:

```powershell
wsl --install
```

3. 컴퓨터 재시작
4. Docker Desktop 재실행

### 2.2 프로젝트 파일 준비

#### 2.2.1 프로젝트 다운로드

다음 중 한 가지 방법을 선택하여 프로젝트를 다운로드합니다.

**방법 1: Git Clone (권장)**

Git이 설치되어 있는 경우:

```bash
git clone https://github.com/abcseagrs/tenseal-lab.git
cd tenseal-lab
```

**방법 2: ZIP 파일 다운로드**

1. [GitHub 저장소](https://github.com/abcseagrs/tenseal-lab) 접속
2. 녹색 "Code" 버튼 클릭
3. "Download ZIP" 선택
4. 다운로드한 ZIP 파일을 원하는 위치에 압축 해제

예시: `C:\Users\학생이름\tenseal-lab`

**방법 3: USB 배포**

실습 자료를 USB로 받은 경우, 원하는 위치에 복사합니다.

#### 2.2.2 디렉토리 구조 확인

```
tenseal-lab/
├── docker/
│   └── Dockerfile          # 도커 이미지 설정
├── docs/
│   ├── he-lab-guide.md     # 개발자 가이드
│   └── lab-manual.md       # 이 문서
├── init/
│   └── requirements.txt    # Python 패키지 목록
├── src/
│   ├── pc_a.py             # 서버 코드
│   └── pc_b.py             # 클라이언트 코드
├── build.bat               # 빌드 스크립트 (Windows)
├── run_test.bat            # 테스트 실행 (Windows)
├── run_server.bat          # 서버 실행 (Windows)
└── run_client.bat          # 클라이언트 실행 (Windows)
```

### 2.3 도커 이미지 빌드

#### 2.3.1 명령 프롬프트 열기

1. `tenseal-lab` 폴더로 이동
2. 주소창에 `cmd` 입력 후 Enter
3. 또는 폴더 내에서 마우스 우클릭 → "터미널에서 열기"

#### 2.3.2 빌드 실행

```bash
build.bat
```

#### 2.3.3 빌드 소요 시간

- 최초 빌드: **약 5~10분** (TenSEAL 라이브러리 컴파일)
- 2회차 이후: 약 1~2분

#### 2.3.4 빌드 성공 확인

다음 메시지가 출력되면 성공:

```
[성공] 빌드가 완료되었습니다!
```

---

## 3. 프로그램 실행 방법

### 3.1 실습 방법 선택

두 가지 방법 중 선택:

| 방법 | 설명 | 용도 |
|------|------|------|
| **방법 1: 테스트 모드** | 1개 PC에서 2개 터미널 사용 | 코드 동작 확인, 혼자 연습 |
| **방법 2: 실제 실습** | 2개 PC를 네트워크로 연결 | 2인 1조 실습, 실전 경험 |

---

### 3.2 방법 1: 테스트 모드 (1개 PC)

#### Step 1: 서버 실행

**터미널 1 열기:**
```bash
run_test.bat
```

다음 메시지가 출력되면 대기 상태:
```
[A] 동형암호 키 생성 중...
[A] 내 데이터: [10, 20]
[A] PC B의 접속 대기 중... (Port: 5000)
```

#### Step 2: 클라이언트 실행

**새 터미널 2 열기** (터미널 1은 그대로 둔 채):

```bash
docker exec -it he-lab-test bash
```

컨테이너 내부 프롬프트에서:
```bash
python src/pc_b.py
```

IP 주소 입력 프롬프트에서 `localhost` 입력:
```
PC A의 IP 주소 (docker-compose면 'pc_a' 입력): localhost
```

#### Step 3: 결과 확인

**터미널 1 (PC A) 출력:**
```
[A] PC B 접속 완료: ('127.0.0.1', 12345)
[A] Public Context 전송 완료
[A] B의 암호화 데이터 수신 완료
========================================
[결과] A의 데이터: [10, 20]
[결과] 합산 (복호화): [40, 60]
========================================
```

**터미널 2 (PC B) 출력:**
```
[B] localhost:5000 에 연결 시도 중...
[B] 연결 성공!
[B] Public Context 수신 완료
[B] 내 데이터: [30, 40] → 암호화 완료
[B] 암호화 데이터 전송 완료
========================================
[B] 전송 완료! 결과는 PC A에서 확인하세요.
========================================
```

---

### 3.3 방법 2: 실제 1:1 실습 (2개 PC)

#### 사전 준비

1. **양쪽 PC 모두** `tenseal-lab` 프로젝트 폴더 준비
2. **양쪽 PC 모두** `build.bat` 실행 완료
3. **같은 WiFi 또는 유선 네트워크**에 연결

#### Step 1: PC A (서버 역할) - 먼저 실행

**PC A 학생이 실행:**

```bash
run_server.bat
```

다음 메시지 확인:
```
[A] 동형암호 키 생성 중...
[A] 내 데이터: [10, 20]
[A] PC B의 접속 대기 중... (Port: 5000)
```

**PC A의 IP 주소 확인:**

새 명령 프롬프트에서:
```bash
ipconfig
```

출력에서 "IPv4 주소" 확인 (예: `192.168.0.10`)

**PC B 학생에게 IP 주소 전달**

#### Step 2: PC B (클라이언트 역할) - PC A 대기 확인 후 실행

**PC B 학생이 실행:**

```bash
run_client.bat
```

IP 주소 입력 프롬프트에서 **PC A의 IP 주소** 입력:
```
PC A의 IP 주소 (docker-compose면 'pc_a' 입력): 192.168.0.10
```

#### Step 3: 결과 확인

**PC A 화면:**
```
[A] PC B 접속 완료: ('192.168.0.15', 54321)
[A] Public Context 전송 완료
[A] B의 암호화 데이터 수신 완료
========================================
[결과] A의 데이터: [10, 20]
[결과] 합산 (복호화): [40, 60]
========================================
```

**PC B 화면:**
```
[B] 192.168.0.10:5000 에 연결 시도 중...
[B] 연결 성공!
[B] Public Context 수신 완료
[B] 내 데이터: [30, 40] → 암호화 완료
[B] 암호화 데이터 전송 완료
========================================
[B] 전송 완료! 결과는 PC A에서 확인하세요.
========================================
```

---

## 4. 트러블슈팅

### 4.1 도커 관련 문제

#### 문제 1: "Docker Desktop is not running"

**증상:**
```
error during connect: This error may indicate that the docker daemon is not running
```

**해결:**
1. Docker Desktop 실행
2. 트레이 아이콘에서 Docker가 "Running" 상태인지 확인
3. 1~2분 대기 후 재시도

#### 문제 2: WSL 2 오류

**증상:**
```
WSL 2 installation is incomplete
```

**해결:**
1. PowerShell 관리자 권한으로 실행
2. `wsl --install` 실행
3. 컴퓨터 재시작

#### 문제 3: 빌드 시간이 너무 오래 걸림

**원인:** TenSEAL 라이브러리 컴파일 시간

**해결:**
- 정상입니다. 5~10분 대기
- 인터넷 속도에 따라 더 소요될 수 있음

### 4.2 네트워크 연결 문제

#### 문제 4: "Connection refused"

**증상 (PC B):**
```
[B] 연결 실패: PC A가 실행 중인지 확인하세요.
```

**체크리스트:**
- [ ] PC A가 먼저 실행되었는가?
- [ ] PC A에서 "대기 중" 메시지가 출력되었는가?
- [ ] IP 주소를 올바르게 입력했는가?
- [ ] 방화벽에서 5000번 포트가 허용되었는가?

**해결 1: 방화벽 설정 (Windows)**

**방법 A: Docker Desktop 앱 허용 (빠른 방법)**

1. 제어판 → Windows Defender 방화벽
2. "앱 또는 기능이 Windows Defender 방화벽을 통과하도록 허용"
3. "Docker Desktop" 체크 (개인 및 공용 모두)
4. 확인 후 재시도

**방법 B: 포트 5000 직접 허용 (다른 PC와 실습 시)**

다른 PC와 실습할 때는 5000번 포트를 명시적으로 열어야 합니다:

1. 제어판 → Windows Defender 방화벽 → 고급 설정
2. 왼쪽 메뉴에서 "인바운드 규칙" 클릭
3. 오른쪽 "새 규칙..." 클릭
4. 규칙 종류: "포트" 선택 → 다음
5. 프로토콜: "TCP" 선택
6. 특정 로컬 포트: `5000` 입력 → 다음
7. 작업: "연결 허용" 선택 → 다음
8. 프로필: 모두 체크 (도메인, 개인, 공용) → 다음
9. 이름: `TenSEAL Lab Port 5000` 입력 → 마침

**방화벽 규칙 확인:**

PowerShell 관리자 권한으로 실행 후:
```powershell
Get-NetFirewallRule -DisplayName "*5000*" | Format-Table -Property DisplayName, Enabled, Direction, Action
```

출력에서 `Enabled: True`, `Direction: Inbound`, `Action: Allow` 확인

**연결 테스트:**

PC B에서 PC A로 포트 테스트:
```powershell
Test-NetConnection -ComputerName 192.168.0.10 -Port 5000
```

출력 예시:
```
TcpTestSucceeded : True
```

**해결 2: 포트 확인**

PC A에서 새 터미널 열어 확인:
```bash
netstat -an | findstr 5000
```

출력 예시:
```
TCP    0.0.0.0:5000    0.0.0.0:0    LISTENING
```

#### 문제 5: "Connection timed out"

**증상:** 연결 시도 중 멈춤

**해결:**
1. 같은 네트워크에 연결되어 있는지 확인
   - 양쪽 PC에서 `ipconfig` 실행
   - "기본 게이트웨이"가 동일한지 확인
2. PC B에서 PC A로 ping 테스트:
   ```bash
   ping 192.168.0.10
   ```
3. 방화벽 일시 비활성화 후 테스트 (해결 1 참조)

#### 문제 6: 같은 PC에서 run_server.bat와 run_client.bat를 동시에 테스트

**상황:**
- 테스트 모드(`run_test.bat`)가 아닌 실제 실행 스크립트로 같은 PC에서 테스트하고 싶은 경우
- 2개의 독립적인 컨테이너로 실습하고 싶은 경우

**실행 방법:**

**터미널 1 (PC A 서버):**
```bash
run_server.bat
```

다음 메시지 확인:
```
[A] PC B의 접속 대기 중... (Port: 5000)
```

**터미널 2 (PC B 클라이언트):**
```bash
run_client.bat
```

IP 주소 입력 프롬프트에서 **`host.docker.internal`** 입력:
```
PC A의 IP 주소 (docker-compose면 'pc_a' 입력): host.docker.internal
```

**설명:**
- `host.docker.internal`은 Docker 컨테이너 내부에서 호스트 PC를 가리키는 특수 DNS 이름입니다
- `run_server.bat`가 `-p 5000:5000`으로 포트를 매핑하므로, 호스트의 5000번 포트로 접속 가능합니다
- Windows와 macOS의 Docker Desktop에서 지원합니다 (Linux는 `--add-host` 옵션 필요)

**예상 출력:**
```
[B] host.docker.internal:5000 에 연결 시도 중...
[B] 연결 성공!
```

**주의사항:**
- `localhost`를 입력하면 연결에 실패합니다 (컨테이너 내부의 localhost를 의미하게 됨)
- 반드시 `host.docker.internal`을 사용해야 합니다

### 4.3 실행 오류

#### 문제 6: "ModuleNotFoundError: No module named 'tenseal'"

**원인:** 도커 이미지가 제대로 빌드되지 않음

**해결:**
```bash
build.bat
```
재실행 후 빌드 완료 확인

#### 문제 7: 컨테이너가 즉시 종료됨

**증상:** 프로그램이 실행되지 않고 바로 종료

**해결:**
1. 기존 컨테이너 제거:
   ```bash
   docker rm -f he-lab-test
   docker rm -f pc_a
   docker rm -f pc_b
   ```
2. 다시 실행

#### 문제 8: "데이터 수신 중 멈춤"

**원인:** 네트워크 버퍼 문제 (코드에 이미 해결됨)

**해결:**
- 정상 동작입니다. 1~2초 대기
- 5초 이상 멈추면 Ctrl+C로 종료 후 재시도

### 4.4 결과 불일치

#### 문제 9: 결과가 [40, 60]이 아님

**체크리스트:**
- [ ] PC A가 `[10, 20]`을 출력했는가?
- [ ] PC B가 `[30, 40]`을 출력했는가?
- [ ] PC B가 "전송 완료" 메시지를 출력했는가?

**해결:**
1. 코드 수정하지 않았는지 확인
2. `src/pc_a.py`와 `src/pc_b.py`의 `my_data` 값 확인
3. 프로젝트 파일 재다운로드

---

## 5. 실습 확인 사항

### 5.1 필수 확인 항목

실습이 성공적으로 완료되었는지 확인:

- [ ] PC A에서 `[결과] 합산 (복호화): [40, 60]` 출력
- [ ] PC B에서 `[B] 전송 완료!` 메시지 출력
- [ ] PC B 코드에 `secret_key` 관련 코드가 없음을 확인
- [ ] 암호화 상태에서 덧셈이 수행되었음을 이해

### 5.2 교육 포인트 복습

#### 질문 1: PC B는 자신이 암호화한 데이터를 복호화할 수 있나요?

**답:** 아니요. PC B는 비밀키가 없으므로 자신의 데이터조차 복호화할 수 없습니다.

#### 질문 2: 네트워크에서 데이터를 가로챈다면 평문이 노출되나요?

**답:** 아니요. 전송되는 데이터는 모두 암호화되어 있으므로 비밀키 없이는 복호화할 수 없습니다.

#### 질문 3: 덧셈은 누가 수행하나요?

**답:** PC A가 암호화된 상태(`enc_a + enc_b`)에서 덧셈을 수행합니다. 평문으로 복호화하지 않고도 연산이 가능합니다.

#### 질문 4: 만약 PC B도 결과를 알고 싶다면?

**답:** PC A가 결과를 다시 암호화하여 전송하거나, PC B에게도 복호화 권한을 부여해야 합니다. (확장 과제)

### 5.3 추가 실험 (선택)

실습 완료 후 다음을 시도할 수 있습니다:

#### 실험 1: 데이터 값 변경

`src/pc_a.py`의 `my_data = [10, 20]`을
`my_data = [100, 200]`으로 변경 후 재실행

예상 결과: `[130, 240]`

#### 실험 2: 곱셈 연산

`src/pc_a.py`의 덧셈 코드:
```python
result_enc = enc_a + enc_b
```

곱셈으로 변경:
```python
result_enc = enc_a * enc_b
```

예상 결과: `[300, 800]` (10×30=300, 20×40=800)

#### 실험 3: 네트워크 패킷 캡처 (고급)

Wireshark 등의 도구로 패킷을 캡처하면:
- 암호문만 보이고 평문은 노출되지 않음
- 이것이 프라이버시 보존 연산의 핵심

---

## 6. 참고 자료

### 6.1 공식 문서

- [TenSEAL 공식 문서](https://github.com/OpenMined/TenSEAL)
- [Docker 공식 문서](https://docs.docker.com/)

### 6.2 추가 학습

- BFV 스킴: 정수 연산에 최적화된 동형암호 방식
- CKKS 스킴: 실수 연산에 최적화된 방식
- 완전 동형암호(FHE): 덧셈과 곱셈을 무제한으로 수행 가능

### 6.3 실습 질문

실습 중 문제가 발생하면:
1. 이 매뉴얼의 트러블슈팅 섹션 참조
2. 조교 또는 담당 교수님께 문의
3. 프로젝트 폴더의 `docs/he-lab-guide.md` 참조

---

## 실습 완료

동형암호 기술은 프라이버시를 보호하면서도 데이터 분석을 가능하게 하는 핵심 기술입니다.
본 실습을 통해 암호화된 상태에서의 연산이라는 개념을 실제로 구현하고 이해할 수 있습니다.
